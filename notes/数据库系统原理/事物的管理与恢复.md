### 事物

##### 为什么?

因为在现实应用中，数据库的操作与操作之间往往具有一定的语义和关联性。数据库应用希望将这些有关联的操作当作一个逻辑工作单元看待，要么都执行，要么都不执行。如果有些执行有些未执行,则会出现数据库内容和现实生活情况不一样.

##### 怎么办
为解决上述问题，数据库管理系统引入了事务概念，它将这些有内在联系的操作当作一个逻辑单元看待，并采取相应策略保证一个逻辑单元内的全部操作要么都执行成功，要么都不执行。

对数据库用户而言，只需将具有完整逻辑意义的一组操作正确地定义在一个事务之内即可。

##### 事物的概念

- 对于用户而言，事务是具有完整逻辑意义的数据库操作序列的集合。
- 对于数据库管理系统而言，事务则是一个读写操作序列。这些操作是一个不可分割的逻辑工作单元，要么都做，要么都不做。
- 事务是数据库管理系统中竞争资源、并发控制和恢复的基本单元。 它是由数据库操作语言(如SQL)或高级编程语言（如Java、C、C++）提供的事务开始语句、事务结束语句以及由它们包含的全部数据库操作语句组成。

##### 事物的结束语句

两种类型:
- 事物提交(commit):
	将成功完成事务的执行结果(即更新)永久化，并释放事务占有的全部资源。
- 事物回滚(rollback)
	中止当前事务、撤销其对数据库所做的更新，并释放事务占有的全部资源。

##### SQL Server事务模式

提供了三种类型的事务模式：
- **显式事务**: 是指用户使用Transact-SQL事务语句所定义的事务，其事务语句包括：
	- 事务开始：`BEGIN TRANSACTION`
	- 事务提交：`COMMIT TRANSACTION`，`COMMIT WORK`
	- 事务回滚：`ROLLBACK TRANSACTION`，`ROLLBACK WORK`
- **隐式事务**: 指事务提交或回滚后，系统自动开始新的事务。该类事务不需要采用`BEGIN TRANSACTION`语句标识事务的开始。
- **自动定义事务**：当一个语句成功执行后，它被自动提交，而当执行过程中出错时，则被自动回滚。

##### 事物特性
- 为了保证事务并发执行或发生故障时数据库的一致性(完整性),事务应具有以下`ACID`特性：
	- 原子性(atomicity). 事务的所有操作要么全部都被执行,要么都不被执行.
	- 一致性(consistency). 一个单独执行的事务应保证其执行结果的一致性,即总是将数据库从一个一致性状态转化到另一个一致性状态.
	- 隔离性(isolation). 当多个事务并发执行时,一个事务的执行不能影响另一个事务,即并发执行的各个事务不能互相干扰.
	- 持久性(durability). 一个事务成功提交后,它对数据库的改变必须是永久的, 即使随后系统出现故障也不会受到影响.

##### DBMS保证事务特性措施
- **原子性**也称为故障原子性或(故障)可靠性
	- 由DBMS通过撤销未完成事务对数据库的影响来实现。
- **一致性**是指单个事务的一致性，也称为并发原子性或正确性
	- 由编写该事务代码的应用程序员负责，但有时也可利用DBMS提供的数据库完整性约束(如触发器)的自动检查功能来保证。
- **隔离性**也称为执行原子性或可串行化，可以看作是多个事务并发执行时的一致性或正确性要求
	- 由DBMS的并发控制模块保证。
- **持久性**也称为恢复原子性或恢复可靠性
	- 它是利用已记录在稳固存储介质(如磁盘阵列)中的恢复信息(如日志、备份等)来实现丢失数据(如因中断而丢失的存放在主存中但还未保存到磁盘数据库中去的数据等)的恢复。
	- 它是由DBMS的恢复管理模块保证。

##### 事物的并发执行
数据库管理系统允许多个事务并发执行:
- 优点
	- 增加系统吞吐量(throughput)。吞吐量是指单位时间系统完成事务的数量。当一事务需等待磁盘I/O时，CPU可去处理其它正在等待CPU的事务。这样，可减少CPU和磁盘空闲时间，增加给定时间内完成事务的数量。
	- 减少平均响应时间(average response time)。事务响应时间是指事务从提交给系统到最后完成所需要的时间。事务的执行时间有长有短，如果按事务到达的顺序依次执行，则短事务就可能会由于等待长事务导致完成时间的延长。如果允许并发执行，短事务可以较早地完成。因此，并发执行可减少事务的平均响应时间。
- 缺点
	- 若不对事务的并发执行加以控制，则可能破坏数据库的一致性。

##### 事物并发执行可能遇到的问题
- 读脏数据。
	- 如果事务T<sub>j</sub>读取事务T<sub>i</sub>修改但未提交的数据后，事务T<sub>i</sub>由于某种原因中止而撤销，这时事务T<sub>j</sub>就读取了不一致的数据。数据库中将这种读未提交且被撤销的数据为读“脏数据”。
- 丢失更新。
	- 两个或多个事务都读取了同一数据值并修改，最后提交事务的执行结果覆盖了前面提交事务的执行结果，从而导致前面事务的更新被丢失。
- 不可重复读。
	- 是指事务T<sub>i</sub>两次从数据库中读取的结果不同，可分为三种情况:
		- 事务T<sub>i</sub>读取一数据后，事务T<sub>j</sub>对该数据进行了更改。当事务Ti再次读该数据时，则会读到与前一次不同的值。 
		- 事务T<sub>i</sub>按某条件读取数据库中某些记录后，事务T<sub>j</sub>删除了其中部分记录。当事务T<sub>i</sub>再次按相同条件读取时，发现记录数变少了。（幻影现象1）
		- 事务T<sub>i</sub>按某条件读取数据库中某些记录后，事务T<sub>j</sub>插入了新的记录。当事务T<sub>i</sub>再次按相同条件读取时，发现记录数变多了。（幻影现象2）

##### 事务并发执行得到正确的结果
如果一组并发执行事务的执行结果与它们串行执行得到的结果是相同的，那么就可以认为该并发执行的结果是正确的.

##### 事物调度定义
- 事务并发执行顺序是随机的，将由多个事务操作组成的随机执行序列称为一个调度。
- 对由一组事务操作组成的调度序列而言，应满足下列条件：
	- 该调度应包括该组事务的全部操作；
	- 属于同一个事务的操作应保持在原事务中的执行顺序。

##### 串行调度
- 什么是串行调度?
	- 在调度S中,如果属于同一事务的操作都是相邻的,则称S是串行调度.
- 对由n个事务组成的一组事务而言,共有n!种有效串行调度.
- 事务串行执行可保证数据库的一致性,如果能判断一个并发调度的执行结果等价于一个串行调度的结果,就称该并发调度可保证数据库的一致性.

##### 冲突操作与冲突等价




### 并发控制



